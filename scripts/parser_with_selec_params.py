#!/bin/bash
# Copyright (c) 2019 Intel Corporation
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Author: Pradeep, Sakhamoori <pradeep.sakhamoori@intel.com>
# Date : 11/10/2021

import pandas as pd
import sys, os
from argparse import ArgumentParser, SUPPRESS
import parser_config as pc

#NUM_OF_INSTANCE = [1, 2] #, 3, 4]  # Mapped values of (1, 2, 4, 8)
#SEQ_LENGTH = [20, 32] #, 128, 384, 512]
#BATCH_SIZE = [8, 4] #[8, 4, 2, 1]
#BACK_END = ['torchscript', 'openvino', 'tensorflow']

NUM_OF_INSTANCE = []
SEQ_LENGTH = []
BATCH_SIZE = []
BACK_END = []

def build_argparser():

    usage = '''example:
     python3 parser_with_selec_params.py -i '/path/to/dir benchmark csv files generated by launch_results_parser.py' 
          -o <optional: path to output dir to save summary_results.csv>
     '''
    
    parser = ArgumentParser(prog='parser_with_selec_params.py',
                            description='Arrange row/column results data for plotting',
                            epilog=usage)
    args = parser.add_argument_group('Options')
    args.add_argument('-i', '--input_dir', help='Benchmark csv files direcotry path', required=True)
    args.add_argument('-c', '--config_file', help='Path to HF tune config params file (txt)', required=True)
    args.add_argument('-o', '--output_dir', help='Output results summary file .csv', required=False, type=str, default='result_summary.csv & plot_results.csv')
    
    return parser

def plot_results(summary_df, seqLen, numInst, backEnd, batchSize):

    plot_df = pd.DataFrame()
    for seq_len in seqLen:
        for idx, no_ins in enumerate(numInst):
                df = summary_df.loc[(summary_df['batch_size'] == batchSize[idx]) & (summary_df['seq_len'] == seq_len) & \
                                       (summary_df['instance_id'] == no_ins)]
              
                if not df.empty:
                   back_end = df.backend.unique()
                   #df_temp = pd.DataFrame()
                   df_ = pd.DataFrame(columns=['sl','inst','bs','threads','torchscript','openvino', 'tensorflow'])
                   ov_l = []
                   pt_l = []
                   num_threads = []
                   for index, row in df.iterrows():
                       if row.loc['backend'] in backEnd:
                           if row.backend == 'torchscript':
                               pt_latency = row.loc['latency_mean (ms)']
                           elif row.backend == 'tensorflow':
                               tf_latency = row.loc['latency_mean (ms)']
                       if row.loc['backend'] == 'openvino' and row.backend == 'openvino':
                               ov_latency = row.loc['latency_mean (ms)']

                   df_.loc[df_.index.max() + 1, :] = [row.loc['seq_len'], row.loc['instance_id'], row.loc['batch_size'], \
                                                           row.loc['num_threads'], pt_latency, ov_latency, tf_latency]
                   plot_df = plot_df.append(df_)
    plot_df = plot_df.drop_duplicates()
    plot_df.to_csv("plot_results.csv", encoding='utf-8', index=False)

def main():
    args = build_argparser().parse_args()

    if not os.path.isdir(args.input_dir):
        print("ERROR: Direcotry not found..")
        return -1
    if not os.listdir(args.input_dir):
        print("ERROR: No files found...")
        return -1
    if not os.path.isfile(args.config_file):
        print("ERROR: Config file not found")
        return -1

    # parsing HF tune config file to read batch_size, sequnece length and number of instance params
    hf_config = open(args.config_file)
    BACK_END, BATCH_SIZE, SEQ_LENGTH, NUM_OF_INSTANCE = pc.hfconfig_parser(hf_config)
    
    print("Parsing benchmark results .csv..!")

    summary_df = pd.DataFrame()
    for file_name in os.listdir(args.input_dir):
        csv = os.path.isfile(os.path.join(args.input_dir, file_name))
        f_n = os.path.splitext(file_name)[0]
        f_ext = os.path.splitext(file_name)[-1].lower()
        if f_ext == ".csv" and csv:
            df = pd.read_csv(os.path.join(args.input_dir, file_name))
            back_end = df.backend.unique()
            seq_len = df.seq_len.unique()
            batch_size = df.batch_size.unique()
            num_threads = df.num_threads.unique()
            num_instance = df['instance_id'].unique()
            total_inst = len(num_instance)
            # Backend
            for backend in back_end:
              df_backend = df.loc[df['backend'] == backend]
              # Sequnce length
              for sl in seq_len:
                  df_seq_len = df_backend.loc[df_backend['seq_len'] == sl]
                  # Numb of threads
                  for nt in num_threads:
                      df_num_threads = df_seq_len.loc[df_seq_len['num_threads'] == nt]
                      # Batch size
                      for bs in batch_size:
                          summary_temp = pd.DataFrame()
                          df_bs = df_num_threads.loc[df_num_threads['batch_size'] == bs]
                          df_bs = df_bs[['instance_id', 'throughput', 'latency_mean (ms)', 'seq_len', 'batch_size', 'num_threads']]
                          df_bs_m = df_bs.mean(axis=0)
                          summary_temp = summary_temp.append(df_bs_m, ignore_index=True)
                          summary_temp['model_name'] = f_n
                          summary_df = summary_df.append(summary_temp.assign(backend=backend))
    summary_df = summary_df.drop_duplicates()
    summary_df.to_csv("results_summary.csv", encoding='utf-8', index=False)
    print("results_summary.csv generated..!")
    plot_results(summary_df, SEQ_LENGTH, NUM_OF_INSTANCE, BACK_END, BATCH_SIZE)
    print("plot_results .csv generated..!")

if __name__ == '__main__':
    sys.exit(main() or 0)